# chgksuite #

**chgksuite** — это набор скриптов, облегчающих редактирование пакетов ЧГК.

## Функции ##

парсинг в формат микроразметки `.4s`:

- из *plain text* (`.txt`)
- из *Word 2007+* (`.docx`)

экспорт из `.4s`:

  * в `.docx` для тестирования с возможностью автоматического забеления ответов, комментариев и источников;
  * в _LaTeX_ (`.tex`) для красивой вёрстки и печати / чтения с планшета;
  * в ЖЖ (преамбула — в теле поста, вопросы — в комментариях, по одному в каждом) с возможностью автоматического скрытия ответов, комментариев и источников за спойлерами, а также автоматической загрузки изображений на хостинг imgur.
 * автоматическая расстановка «правильных» кавычек и тире, в _LaTeX_ также малых прописных (_small caps_).
 * поддержка нулевых вопросов и вопросов с произвольными идентификаторами

## Пока не сделано ##

- экспорт в html
- импорт из html/xml (из Базы)
- streaming режим (поддержка pipe’ов)

## Я не программист. Что мне делать? ##

Специально для вас есть [инструкция с картинками](https://bitbucket.org/pecheny/chgksuite/src/tip/nontechies.md) (устарела, применима к v0.1). Читайте и пользуйтесь!

## Как установить ##

Вы можете скачать [последнюю версию репозитория](https://bitbucket.org/pecheny/chgksuite/get/tip.zip). Если у вас есть _Python_, вы можете воспользоваться `.py`-скриптами из архива, удовлетворив все зависимости, перечисленные [здесь](https://bitbucket.org/pecheny/chgksuite/src/tip/requirements.md),  через `pip install`. Если вы пользуетесь _Mercurial_, можете также клонировать репозиторий, скопировав ссылку из интерфейса _Bitbucket_.

Если у вас нет _Python_ или просто лень возиться, качайте:

### v0.2rc2

- Windows: [v0.2rc2.zip](https://bitbucket.org/pecheny/chgksuite/downloads/v0.2rc2.zip)

### v0.2rc1

Этот архив самодостаточен: можно распаковать его в папку и пользоваться.

- Windows: [v0.2rc1.zip](https://dl.dropboxusercontent.com/u/24653887/chgk/v0.2rc1.zip)

### v0.1 (устарела, не рекомендуется к использованию)

- Windows: [chgk_parser](https://dl.dropboxusercontent.com/u/24653887/chgk/chgk_parser.exe), [chgk_composer](https://dl.dropboxusercontent.com/u/24653887/chgk/chgk_composer.exe). 
- OS X: [chgk_parser](https://dl.dropboxusercontent.com/u/24653887/chgk/osx/chgk_parser), [chgk_composer](https://dl.dropboxusercontent.com/u/24653887/chgk/osx/chgk_composer).
- Ubuntu: [chgk_parser](https://dl.dropboxusercontent.com/u/24653887/chgk/ubuntu/chgk_parser), [chgk_composer](https://dl.dropboxusercontent.com/u/24653887/chgk/ubuntu/chgk_composer).

Эти бинарные файлы не работают сами по себе. Дополнительно к ним нужно распаковать следующие файлы из репозитория:

- `template.docx`
- `cheader.tex`
- `fix-unnumbered-sections.sty`

## Как пользоваться ##

Это инструкция для версии 0.2, старую инструкцию можно почитать [тут](https://bitbucket.org/pecheny/chgksuite/src/ec35da5/README.md).

У `chgksuite` есть два режима работы — полностью консольный и консольный с элементами GUI. **Вы можете просто запустить программу и использовать режим с элементами GUI, следуя инструкциям на экране**. Если это для вас сложно — вам [сюда](https://bitbucket.org/pecheny/chgksuite/src/tip/nontechies.md).

Инструкция ниже относится к консольному режиму.

`chgksuite parse (filename).(ext)` — парсит входной файл `(filename).(ext)` и создаёт `(filename).4s`. Тип файла (_Word_ или _plain text_) определяется по расширению, поэтому убедитесь, что ваши файлы имеют корректные расширения. Так, `chgk_parser.py paket.docx` создаст файл `paket.4s`.

`chgksuite compose (filename).4s (output-filetype) (-l lj-user (-c community) (-p pa$sw0rd)) (--nospoilers|-n) (--noanswers) (--rawtex)` — создаёт из `.4s`-файла выходной файл указанного типа. Допустимые значение `(output-filetype)` — `docx`, `tex` и `lj`. В первых двух случаях будет создан выходной файл `(filename).docx` и `(filename).pdf`, соответственно (флаг `--rawtex` копирует также tex-файлы для самостоятельной компиляции). 

При указании `lj` в качестве выходного формата также можно указать параметры `-l lj-user`, где `lj-user` — ваш логин в ЖЖ. Можно также указать пароль через  `-p lj-password`. Если вы этого не сделаете, пароль у вас спросят в диалоговом окне или в консоли.

Если вы выкладываете пакет не в личный ЖЖ, а в сообщество, после `-l lj-user` введите `-c community`, где `community` — название сообщества (например, `ru_chgk`). Обратите внимание, что **выкладка в личный ЖЖ по умолчанию происходит «под глаз»**, так что итоговый пост виден только вам. Вы сможете посмотреть, всё ли выглядит так, как вы задумали, и после этого через форму редактирования поста на сайте ЖЖ изменить настройки видимости, чтобы его могли увидеть и другие пользователи. При выкладке в сообщество, однако, создатели ЖЖ не предусмотрели возможность выкладки «под глаз», так что **выкладка в сообщество публична**. Поэтому перед тем, как выложить пакет в сообщество, можно выложить пакет в личный ЖЖ под глаз, чтобы удостовериться, что пакет выглядит именно так, как вы задумывали.

Учтите также, что из-за технических ограничений ЖЖ невозможно выложить более чем 20 комментариев к одному и тому же посту автоматически, поэтому если в вашем туре более 20 вопросов, какую-то их часть вам придётся выложить вручную.

Для режимов `docx` и `lj` по умолчанию включен режим «спойлеров», чтобы читатель не видел ответы и комментарии. Добавление `--nospoilers` к строке вызова программы позволяет вывести результат без спойлеров.

Также для всех режимов работает опция `--debug` для вывода отладочной информации. Если у вас что-то не работает или работает не так, как нужно, [создайте тикет](https://bitbucket.org/pecheny/chgksuite/issues?status=new&status=open) и пришлите туда эти файлы.

Примеры:

- `chgksuite compose paket.4s docx` — создаст файл `paket.docx` с забелёнными ответами и комментариями.
- `chgksuite compose paket.4s docx --nospoilers` — создаст файл `paket.docx` без забелённых ответов.
- `chgksuite compose paket.4s tex` — создаст файл `paket.pdf`, если у вас установлен LaTeX (используется движок `xelatex`, который есть во всех современных дистрибуциях LaTeX). Обратите внимание, что PDF-файлы предназначены для того, чтобы их читал ведущий на игре с распечатки или экрана планшета. Спойлеры в них не предусмотрены.
- `chgksuite compose paket.4s lj -l pecheny` — выложит пакет со спойлерами в ЖЖ `pecheny`. Запись будет видна только пользователю `pecheny`.
- `chgksuite compose paket.4s lj -l pecheny -c ru_chgk --nospoilers` — выложит пакет без спойлеров в сообщество `ru_chgk` от лица пользователя `pecheny`. Запись будет видна всем.

## Микроформат .4s ##

Микроформат _4s_ вдохновлён существующими микроформатами типа _Markdown_ и _reStructuredText_, однако отличается от них в силу специфики структуры пакетов ЧГК. Пакет в формате _4s_ состоит из последовательности элементов, принадлежащих к одному из типов. В начале строки записывается идентификатор типа элемента, а затем через 1 или более пробелов — его значение. Строчка без идентификатора типа в начале считается продолжением предыдущего элемента (внутри элемента разрешены **одинарные** переносы строк). Разные элементы отделяются двумя или более переносами строки. Существуют следующие типы элементов:

- `###`: заголовок.
- `###LJ`: заголовок для поста в ЖЖ, если вы хотите, чтобы он не совпадал с заголовком в теле поста (например, если последний — слишком длинный).
- `#EDITOR`: редактор.
- `#DATE`: дата/место турнира (отображающаяся в начале документа)
- `#`: любой метакомментарий, например, благодарности тестерам в преамбуле.
- `?`: текст вопроса.
- `№`: номер вопроса, если вы предпочитаете ручную нумерацию автоматической. Его следует использовать для ввода нулевых вопросов. Это поле строковое, так что возможны вопросы с номерами `000`, `3.14`, `14a`, `мой любимый` etc.
- `№№` — установка счётчика номеров вопросов. При использовании `№` номер изменится только у данного вопроса, а при использовании `№№` — у данного вопроса и всех последующих с шагом в единицу, как обычно и нужно в пакете. В отличие от поля `№`, у поля `№№` допускаются только числовые значения.
- `!`: ответ.
- `=`: зачёт.
- `!=`: незачёт.
- `/`: комментарий.
- `^`: источник(и).
- `@`: автор(ы).

Из них элементы «вопрос» (`?`) и «ответ» (`!`) являются обязательными, прочие — опциональны.

Внутри элементов также возможно следующее дополнительное форматирование:

- ```удар`ение```: ударе́ние
- `_курсив_`: _курсив_
- `(img w=20px h=40px kotik.jpg)`: вставка локального изображения `kotik.jpg` шириной 20 пикселей и высотой 40 пикселей. Показатели ширины и высоты __опциональны__; более того, их чаще всего не нужно использовать, так как программа автоматически проставляет размер.
- `-`: маркер элемента списка. Списки удобны для оформления нескольких источников, а также дуплетов и блицев.

Таким образом, начало пакета в формате _4s_ может выглядеть так:
```
### XIII Кубок Ленинского района, организованный А. А. Петровым, милостивым и милосердным, на деньги холдинга «Вектор»
###LJ Кубок Ленинского района
#EDITOR Редактор — С. Каценеленбоген
#DATE 30 февраля 2014

# Редактор благодарит тестеров и свою маму.

? [Раздаточный материал: (img test.jpg)]
Уважаемые знатоки! Что вы видите на этой розданном вам изображении?
№ 0
! гиппопотам.
= бегемот.
/ изображение напоминает бегемота в солнечный день, если его перевернуть.
^ 
- З. Фрейд. Психопатология обыденной жизни
- Г. Роршах. Психодиагностика
@ С. Каценеленбоген
```