# chgksuite

**chgksuite** — это набор скриптов, облегчающих редактирование пакетов ЧГК.

## Функции

* парсинг в формат микроразметки `.4s`:

    - из *plain text* (`.txt`)
    - из *Word 2007+* (`.docx`)

* экспорт из `.4s`:

    - в `.docx` для тестирования с возможностью автоматического забеления ответов, комментариев и источников;
    - в _LaTeX_ (`.tex` → `.pdf`) для красивой вёрстки и печати / чтения с планшета;
    - в ЖЖ (преамбула — в теле поста, вопросы — в комментариях, по одному в каждом) с возможностью автоматического скрытия ответов, комментариев и источников за спойлерами, а также автоматической загрузки изображений на хостинг imgur.
    - в текстовый формат Базы

* автоматическая расстановка «правильных» кавычек, тире и знаков ударения, в _LaTeX_ также малых прописных (_small caps_).

## Я не программист. Что мне делать?

[Новая инструкция для экспорта в формат Базы](https://bitbucket.org/pecheny/chgksuite/src/default/db_readme.md).  
[Старая инструкция с картинками](https://bitbucket.org/pecheny/chgksuite/src/default/nontechies.md).

## Как установить

Для обычных людей:

Последняя версия **v0.5.2** — [для Windows](https://bitbucket.org/pecheny/chgksuite/downloads/chgksuite_v0.5.2_win.zip), [для Mac](https://bitbucket.org/pecheny/chgksuite/downloads/chgksuite_v0.5.2_mac.zip).

[В разделе «Загрузки»](https://bitbucket.org/pecheny/chgksuite/downloads/) можно найти и более старые версии, если они вам нужны.

Если вы разработчик: склонируйте [или скачайте](https://bitbucket.org/pecheny/chgksuite/get/tip.zip) репозиторий. Установите зависимости из requirements и requirements_dev. Дополнительные детали можно найти в [инструкции для разработчиков](https://bitbucket.org/pecheny/chgksuite/src/default/dev_readme.md).

## Как пользоваться

У `chgksuite` есть два режима работы — полностью консольный и консольный с элементами GUI. Вы можете просто запустить программу и использовать режим с элементами GUI, следуя инструкциям на экране.

Инструкция ниже относится к консольному режиму.

### Парсинг в формат 4s

```
chgksuite parse [--defaultauthor] [--encoding ENCODING]
                [--parsedir]
                [filename]
```

Парсинг входного файла `filename.docx` или `filename.txt` в файл `filename.4s`. Тип файла (_Word_ или _plain text_) определяется по расширению, поэтому убедитесь, что ваши файлы имеют корректные расширения.

При запуске с флагом `--defaultauthor` программа подставляет в поле «Автор» имя файла, если поле «Автор» отсутствует. Это удобно в случае, когда вам один человек прислал много вопросов, при этом не подписав каждый из них. После обработки вопросов вы сможете сделать массовую замену имени файла на имя и фамилию автора.

При запуске с флагом `--parsedir` аргументом вместо имени файла должно служить имя каталога. Все файлы подходящих форматов, находящихся в этом каталоге, будут распаршены и сохранены в этом же каталоге в формате 4s.

Если у вас имеется файл в экзотической кодировке, которую _chgksuite_ не может понять самостоятельно, вы можете передать кодировку прямо при помощи флага `--encoding`.

### Выгрузка из формата 4s

#### docx

```
chgksuite compose docx [-h] [--nospoilers] [--noanswers]
                       [--noparagraph] [--randomize]
                       [filename [filename ...]]
```

Создание из `filename.4s` файла `filename.docx`. Через пробел можно перечислить несколько входных файлов, все они будут обработаны по порядку.

Флаг `--nospoilers` отключает спойлеры.

Флаг `--noanswers` отключает ответы. Это полезно для случаев, когда вы распечатываете пакет для отыгрыша без ведущего.

Флаг `--randomize` перед созданием `docx` файла перемешивает вопросы в случайном порядке.

Флаг `--noparagraph` выключает перенос строки после начала вопроса (`Вопрос 1.`)

#### tex

`chgksuite compose tex [-h] [--rawtex] [filename [filename ...]]`

Создание из `filename.4s` файла `filename.pdf`. Через пробел можно перечислить несколько входных файлов, все они будут обработаны по порядку.

Если вы хотите вручную отредактировать `tex` файл после создания, используйте флаг `--rawtex`.

#### lj

```
chgksuite compose lj [-h] [--nospoilers] [--splittours] [--genimp]
                     [--login LOGIN] [--password PASSWORD]
                     [--community COMMUNITY]
                     [filename [filename ...]]
```

Загрузка файла `filename.4s` в ЖЖ. Через пробел можно перечислить несколько входных файлов, все они будут обработаны по порядку.

Флаги `--login`, `--password` и `--community` позволяют задать, соответственно, логин, пароль и сообщество для выкладки. Если сообщество не задано, выкладка будет произведена в личный ЖЖ, указанный в `--login`. Если логин и пароль не указаны, появится диалоговое окно, где можно будет их ввести.

Выкладка в личный ЖЖ происходит «под глаз», после неё вы сможете просмотреть посты на отсутствие ошибок и сделать их публичными. В сообществах такой опции нет, все посты в сообществе сразу же видны. Поэтому советую сначала выложить пакет в личный ЖЖ, проверить, поправить, и только после этого выкладывать в сообщество.

Учтите также, что из-за технических ограничений ЖЖ невозможно выложить более чем 20 комментариев к одному и тому же посту автоматически, поэтому если в вашем туре более 20 вопросов, какую-то их часть вам придётся выложить вручную.

Флаг `--nospoilers` отключает спойлеры.

Флаг `--splittours` включает разбиение пакета по турам: один тур — один пост. Этот флаг стоит применять, только когда пакет лежит в одном файле 4s. Если для каждого тура у вас свой файл, просто укажите их по порядку через пробел в строке запуска.

Также для всех режимов работает опция `--debug` для вывода отладочной информации. Если у вас что-то не работает или работает не так, как нужно, запустите `chgksuite` с этим ключом, а затем [создайте тикет](https://bitbucket.org/pecheny/chgksuite/issues?status=new&status=open) и пришлите туда файлы `composer.log`, `parser.log` (лежат в папке с _chgksuite_) и `debug*.json` (лежат в папке с `docx` или `4s` файлами).

Примеры:

- `chgksuite compose docx paket.4s` — создаст файл `paket.docx` с забелёнными ответами и комментариями.
- `chgksuite compose docx paket.4s --nospoilers` — создаст файл `paket.docx` без забелённых ответов.
- `chgksuite compose tex paket.4s` — создаст файл `paket.pdf`, если у вас установлен LaTeX (используется движок `xelatex`, который есть во всех современных дистрибуциях LaTeX). Обратите внимание, что PDF-файлы предназначены для того, чтобы их читал ведущий на игре с распечатки или экрана планшета. Спойлеры в них не предусмотрены.
- `chgksuite compose lj -l pecheny paket.4s` — выложит пакет со спойлерами в ЖЖ `pecheny`. Запись будет видна только пользователю `pecheny`.
- `chgksuite compose lj paket.4s -l pecheny -c ru_chgk --nospoilers` — выложит пакет без спойлеров в сообщество `ru_chgk` от лица пользователя `pecheny`. Запись будет видна всем.

#### base

`chgksuite.py compose base filename.4s` — создаёт текстовый файл формата Базы. Опций нет.

## Микроформат .4s ##

Микроформат _4s_ вдохновлён существующими микроформатами типа _Markdown_ и _reStructuredText_, однако отличается от них в силу специфики структуры пакетов ЧГК. Пакет в формате _4s_ состоит из последовательности элементов, принадлежащих к одному из типов.

Существуют следующие типы элементов: тур, вопрос, заголовок, заголовок для ЖЖ, редактор, дата, номер вопроса, счётчик номеров и метакомментарий (всё остальное, например, список тестеров). Внутри вопроса существуют следующие подтипы: текст вопроса, ответ, зачёт, незачёт, комментарий, источник(и), автор(ы). Подробно эти типы элементов рассмотрены ниже.

В начале строки записывается идентификатор типа элемента, а затем через 1 или более пробелов — его значение. Строчка без идентификатора типа в начале считается продолжением предыдущего элемента (внутри элемента разрешены одинарные переносы строк). Разные вопросы отделяются двойными переносами строки.

Идентификаторы типа элемента записываются следующим образом:

- `###`: заголовок.
- `###LJ`: заголовок для поста в ЖЖ, если вы хотите, чтобы он не совпадал с заголовком в теле поста (например, если последний — слишком длинный).
- `#EDITOR`: редактор.
- `#DATE`: дата/место турнира (отображающаяся в начале документа)
- `#`: любой метакомментарий, например, благодарности тестерам в преамбуле.
- `##`: тур. Номер тура надо писать явно: `## Тур 1`, `## Разминочные вопросы`, `## Перестрелка` и т.д.
- `?`: текст вопроса.
- `№`: номер вопроса, если вы предпочитаете ручную нумерацию автоматической. Его следует использовать для ввода нулевых вопросов. Это поле строковое, так что возможны вопросы с номерами `000`, `3.14`, `14a`, `мой любимый` etc.
- `№№` — установка счётчика номеров вопросов. При использовании `№` номер изменится только у данного вопроса, а при использовании `№№` — у данного вопроса и всех последующих с шагом в единицу, как обычно и нужно в пакете. В отличие от поля `№`, у поля `№№` допускаются только числовые значения.
- `!`: ответ.
- `=`: зачёт.
- `!=`: незачёт.
- `/`: комментарий.
- `^`: источник(и).
- `@`: автор(ы).

Из них элементы «вопрос» (`?`) и «ответ» (`!`) являются обязательными, прочие — опциональны.

Внутри элементов также возможно следующее дополнительное форматирование:

- ```удар`ение``` или: ударе́ние (можно использовать и [обычный знак ударения](http://www.unicode-symbol.com/u/0301.html))
- `_курсив_`: _курсив_
- `(img w=20px h=40px kotik.jpg)`: вставка локального изображения `kotik.jpg` шириной 20 пикселей и высотой 40 пикселей. Показатели ширины и высоты __опциональны__; более того, их чаще всего не нужно использовать, так как программа автоматически проставляет размер.
- `-`: маркер элемента списка. Списки удобны для оформления нескольких источников, а также дуплетов и блицев.
- `\` — используется для экранирования символов `_` в ссылках на источники, чтобы при экспорте они не были восприняты как знаки курсива. Экранирование происходит автоматически при парсинге, но если вы пишете в 4s руками, его использовать тоже стоит.

Таким образом, начало пакета в формате _4s_ может выглядеть так:
```
###LJ XIV межрегиональный кубок «Интеллектуальная ворона»

### XIV межрегиональный кубок «Интеллектуальная ворона»

#DATE 2019-05-26

## Тур 1

#EDITOR Редактор — Максим Мерзляко́в (Воронеж).

# _Редактор благодарит за тестирование вопросов и ценные замечания Сергея Донецко́ва, Дмитрия Доро́жко, Александра Кама́ева, Дмитрия Ко́гана, Александра Коробе́йникова, Сергея Кру́пника, Александра Мерзли́кина, Юлию Мещеряко́ву, Дениса Ми́кшиса, Олега Михе́ева, Жанну Подоля́к, Дмитрия Пономарёва, Антона Саксо́нова, Дмитрия Сло́уща, Сергея Тере́нтьева, Наи́ляФару́кшина и Сергея Че́лышева._

? [Раздаточный материал:
Но он не шёл. Луна скрывалась,
Луна сияла сквозь туман,
Бежала мгла... И мне казалось,
Что на снегу сидит Сапсан.
Морозный иней, как алмазы,
Сверкал на нём, а он дремал,
Седой, зобастый, круглоглазый,
И в крылья голову вжимал.
]
Заглавный герой стихотворения Бу́нина, фрагмент которого мы вам раздали, молчалив. Тем не менее, по словам Корне́я Чуко́вского, Бунин вдохновлялся… Каким автором?
! Эдгаром Алланом По.
= по фамилии «По» без неверных уточнений.
/ стихотворение называется «Сапсан». Кроме птичьих названий, с «Вороном» Эдгара По его роднит и мистическая атмосфера. Мы приветствуем вас на «Интеллектуальной вороне»!
^ 
- И. Бунин. Сапсан; https://tinyurl.com/y59b6cak
- И. Петрова. Очарованная душа; https://tinyurl.com/y2un4wxe
@ Максим Мерзляков (Воронеж)

? [Ведущему: раздать командам, как обычно, по три экземпляра раздаточного материала! Один из экземпляров команда должна сдать в качестве ответного бланка!]
[Раздаточный материал: (img 001.png)]
Дуплет: два вопроса по 30 секунд обсуждения на каждый. Напишите название своей команды на одном из экземпляров раздаточного материала и сдайте ответы дуплета на нём вместо ответного бланка. Пожалуйста, впишите ответы по соседству: первый — в первые три клетки, второй — в следующие три.
- Правитель Топи́льцин взял себе имя бога Кетцалькоа́тля, которое переводится как «Пернатый Змей». По легенде, он обучил индейцев письму, поэтому некоторые мистики утверждают, что Кетцалькоатль — это ПРОПУСК. Заполните ПРОПУСК.
- В 1860 году население одного из городов Колорадо составляло десять тысяч человек, а в 1890 — двести двадцать два человека. Название этого города — ПРОПУСК. Заполните ПРОПУСК.
! 
- Тот;
- Оро.
= точные ответы.
/ Кетцалькоатля сопоставляют с ибисоголовым богом Тотом, который тоже был пернат и обучил египтян грамоте. Город Оро, н в переводе с испанского означает «золото», был основан во время золотой лихорадки и заброшен после её окончания. Если соединить ответы дуплета, то получится имя заглавного персонажа аниме Хая́о Миядза́ки «Мой сосед То́торо», так что слова «по соседству» могли послужить подсказкой.
^ 
- https://ru.wikipedia.org/wiki/Кетцалькоатль
- https://ru.wikipedia.org/wiki/Тот
- https://tinyurl.com/y3fa7h7e
- https://en.wikipedia.org/wiki/Oro\_City,\_Colorado
- https://ru.wikipedia.org/wiki/Мой\_сосед\_Тоторо
@ Максим Мерзляков (Воронеж)
```